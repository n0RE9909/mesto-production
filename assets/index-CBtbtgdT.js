(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))c(s);new MutationObserver(s=>{for(const d of s)if(d.type==="childList")for(const p of d.addedNodes)p.tagName==="LINK"&&p.rel==="modulepreload"&&c(p)}).observe(document,{childList:!0,subtree:!0});function r(s){const d={};return s.integrity&&(d.integrity=s.integrity),s.referrerPolicy&&(d.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?d.credentials="include":s.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function c(s){if(s.ep)return;s.ep=!0;const d=r(s);fetch(s.href,d)}})();class Q{constructor({baseUrl:e,headers:r}){this._baseUrl=e,this._headers=r}_checkResponse(e){return e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`)}_request(e,r){return fetch(e,r).then(this._checkResponse)}getUserInfo(){return this._request(`${this._baseUrl}/users/me`,{headers:this._headers})}getCardList(){return this._request(`${this._baseUrl}/cards`,{headers:this._headers})}setUserInfo({name:e,about:r}){return this._request(`${this._baseUrl}/users/me`,{method:"PATCH",headers:this._headers,body:JSON.stringify({name:e,about:r})})}setUserAvatar({avatar:e}){return this._request(`${this._baseUrl}/users/me/avatar`,{method:"PATCH",headers:this._headers,body:JSON.stringify({avatar:e})})}addCard({name:e,link:r}){return this._request(`${this._baseUrl}/cards`,{method:"POST",headers:this._headers,body:JSON.stringify({name:e,link:r})})}deleteCard(e){return this._request(`${this._baseUrl}/cards/${e}`,{method:"DELETE",headers:this._headers})}changeLikeCardStatus(e,r){return this._request(`${this._baseUrl}/cards/${e}/likes`,{method:r?"DELETE":"PUT",headers:this._headers})}}const L=new Q({baseUrl:"https://mesto.nomoreparties.co/v1/apf-cohort-202",headers:{authorization:"ca98acee-6a33-4e1f-81c1-7cf980e2f6de","Content-Type":"application/json"}}),F=(o,e,{onPreviewPicture:r,onLikeIcon:c,onDeleteCard:s})=>{const p=document.querySelector("#card-template").content.querySelector(".card").cloneNode(!0),v=p.querySelector(".card__image"),C=p.querySelector(".card__title"),f=p.querySelector(".card__like-button"),y=p.querySelector(".card__control-button_type_delete"),m=p.querySelector(".card__like-count");v.src=o.link,v.alt=o.name,C.textContent=o.name;const h=o.owner._id===e;return h||(y.style.display="none"),o.likes.some(S=>S._id===e)&&f.classList.add("card__like-button_is-active"),m&&(m.textContent=o.likes.length),f.addEventListener("click",()=>{const S=f.classList.contains("card__like-button_is-active");c(o._id,S,f,m)}),h&&y.addEventListener("click",()=>{s(o._id,p)}),v.addEventListener("click",()=>{r()}),p},j=o=>{if(o.key==="Escape"){const e=document.querySelector(".popup_is-opened");k(e)}},b=o=>{o.classList.add("popup_is-opened"),document.addEventListener("keyup",j)},k=o=>{o.classList.remove("popup_is-opened"),document.removeEventListener("keyup",j)},N=o=>{o.querySelector(".popup__close").addEventListener("click",()=>{k(o)}),o.addEventListener("mousedown",r=>{r.target.classList.contains("popup")&&k(o)})},H=(o,e,r,c)=>{const s=o.querySelector(`#${e.id}-error`);s&&(e.classList.add(c.inputErrorClass),s.textContent=r,s.classList.add(c.errorClass))},G=(o,e,r)=>{if(!e)return;const c=o.querySelector(`#${e.id}-error`);c&&(e.classList.remove(r.inputErrorClass),c.classList.remove(r.errorClass),c.textContent="")},W=(o,e,r)=>{const c=/^[A-Za-zА-Яа-яЁё\s\-]+$/;e.validity.patternMismatch||e.classList.contains("popup__input_type_name")&&!c.test(e.value)?H(o,e,e.dataset.errorMessage,r):e.validity.valid?G(o,e,r):H(o,e,e.validationMessage,r)},X=o=>o.some(e=>!e.validity.valid),R=(o,e,r)=>{X(o)?(e.classList.add(r.inactiveButtonClass),e.disabled=!0):(e.classList.remove(r.inactiveButtonClass),e.disabled=!1)},Y=(o,e)=>{const r=Array.from(o.querySelectorAll(e.inputSelector)),c=o.querySelector(e.submitButtonSelector);R(r,c,e),r.forEach(s=>{s.addEventListener("input",function(){W(o,s,e),R(r,c,e)})})},D=o=>{Array.from(document.querySelectorAll(o.formSelector)).forEach(r=>{r.addEventListener("submit",c=>{c.preventDefault()}),Y(r,o)})},P=(o,e)=>{const r=Array.from(o.querySelectorAll(e.inputSelector)),c=o.querySelector(e.submitButtonSelector);r.forEach(s=>{G(o,s,e)}),c&&(c.classList.add(e.inactiveButtonClass),c.disabled=!0)},q={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"};let I=null;function ee(){function o(){const n=document.querySelector(".popup_type_info"),t=n.querySelector(".popup__info"),i=n.querySelector(".popup__list");t&&(t.innerHTML="<p>Загрузка статистики...</p>"),i&&(i.innerHTML=""),L.getCardList().then(u=>{const _=e(u);r(_),b(n)}).catch(()=>{t&&(t.innerHTML="<p>Не удалось загрузить статистику</p>")})}function e(n){const t={totalCards:n.length,totalLikes:0,avgLikes:0,maxLikesFromOne:0,championCard:null,users:{}};return n.forEach(i=>{t.totalLikes+=i.likes.length,(!t.championCard||i.likes.length>t.championCard.likes.length)&&(t.championCard=i);const u={};i.likes.forEach(a=>{const l=a._id;u[l]=(u[l]||0)+1,t.users[l]||(t.users[l]={id:l,name:a.name,about:a.about,avatar:a.avatar,cardsCreated:0,likesReceived:0,likesGiven:0}),t.users[l].likesGiven++}),Object.values(u).forEach(a=>{a>t.maxLikesFromOne&&(t.maxLikesFromOne=a)});const _=i.owner._id;t.users[_]||(t.users[_]={id:_,name:i.owner.name,about:i.owner.about,avatar:i.owner.avatar,cardsCreated:0,likesReceived:0,likesGiven:0}),t.users[_].cardsCreated++,t.users[_].likesReceived+=i.likes.length}),t.avgLikes=t.totalCards>0?(t.totalLikes/t.totalCards).toFixed(1):0,t}function r(n){const t=document.querySelector(".popup__info"),i=document.querySelector(".popup__list");if(!t||!i)return;if(t.innerHTML="",i.innerHTML="",[{term:"Всего карточек",value:n.totalCards},{term:"Всего лайков",value:n.totalLikes},{term:"Среднее лайков на карточку",value:n.avgLikes},{term:"Максимально лайков от одного",value:n.maxLikesFromOne}].forEach(a=>{const l=document.createElement("div");l.className="popup__info-item",l.innerHTML=`
        <dt class="popup__info-term">${a.term}</dt>
        <dd class="popup__info-description">${a.value}</dd>
      `,t.appendChild(l)}),n.championCard){const a=document.createElement("div");a.className="popup__info-item",a.innerHTML=`
        <dt class="popup__info-term">Чемпион лайков</dt>
        <dd class="popup__info-description">${n.championCard.name} (${n.championCard.likes.length} лайков)</dd>
      `,t.appendChild(a)}Object.values(n.users).filter(a=>a.cardsCreated>0).sort((a,l)=>l.likesReceived-a.likesReceived).slice(0,5).forEach(a=>{const l=document.createElement("li");l.className="popup__list-item",l.innerHTML=`
        <strong>${a.name||"Аноним"}</strong><br>
        Карточек: ${a.cardsCreated} | 
        Лайков получил: ${a.likesReceived} | 
        Лайков поставил: ${a.likesGiven}
      `,i.appendChild(l)})}const c=document.querySelector(".profile__edit-button"),s=document.querySelector(".profile__add-button"),d=document.querySelector(".profile__image"),p=document.querySelector(".popup_type_edit"),v=document.querySelector(".popup_type_new-card"),C=document.querySelector(".popup_type_image"),f=document.querySelector(".popup_type_edit-avatar"),y=p.querySelector(".popup__form"),m=v.querySelector(".popup__form"),h=f.querySelector(".popup__form"),g=y.querySelector(".popup__input_type_name"),S=y.querySelector(".popup__input_type_description"),J=h.querySelector(".popup__input_type_avatar"),E=document.querySelector(".profile__title"),x=document.querySelector(".profile__description"),$=document.querySelector(".profile__image"),T=document.querySelector(".places__list"),U=C.querySelector(".popup__image"),V=C.querySelector(".popup__caption");function O(n,t){U.src=t,U.alt=n,V.textContent=n,b(C)}function z(n){n.preventDefault();const t=y.querySelector(".popup__button"),i=t.textContent;t.textContent="Сохранение...",L.setUserInfo({name:g.value,about:S.value}).then(u=>{E.textContent=u.name,x.textContent=u.about,k(p)}).finally(()=>{t.textContent=i})}function K(n){n.preventDefault();const t=m.querySelector(".popup__button"),i=t.textContent;t.textContent="Создание...";const u=m.querySelector(".popup__input_type_card-name").value,_=m.querySelector(".popup__input_type_url").value;L.addCard({name:u,link:_}).then(a=>{const l=F(a,I,{onPreviewPicture:()=>O(a.name,a.link),onLikeIcon:A,onDeleteCard:B});T.prepend(l),m.reset(),k(v)}).finally(()=>{t.textContent=i})}function Z(n){n.preventDefault();const t=h.querySelector(".popup__button"),i=t.textContent;t.textContent="Сохранение...",L.setUserAvatar({avatar:J.value}).then(u=>{$.style.backgroundImage=`url(${u.avatar})`,h.reset(),k(f)}).finally(()=>{t.textContent=i})}function A(n,t,i,u){L.changeLikeCardStatus(n,t).then(_=>{i.classList.toggle("card__like-button_is-active"),u&&(u.textContent=_.likes.length)})}function B(n,t){L.deleteCard(n).then(()=>{t.remove()})}c.addEventListener("click",()=>{g.value=E.textContent,S.value=x.textContent,P(y,q),b(p)}),s.addEventListener("click",()=>{m.reset(),P(m,q),b(v)}),d.addEventListener("click",()=>{h.reset(),P(h,q),b(f)}),y.addEventListener("submit",z),m.addEventListener("submit",K),h.addEventListener("submit",Z),Promise.all([L.getUserInfo(),L.getCardList()]).then(([n,t])=>{I=n._id,E.textContent=n.name,x.textContent=n.about,$.style.backgroundImage=`url(${n.avatar})`,t.reverse().forEach(i=>{const u=F(i,I,{onPreviewPicture:()=>O(i.name,i.link),onLikeIcon:A,onDeleteCard:B});T.append(u)})}),[p,v,C,f].forEach(n=>{N(n)}),D(q);const M=document.querySelector(".header__logo");M&&M.addEventListener("click",o);const w=document.querySelector(".popup_type_info");w&&N(w)}document.addEventListener("DOMContentLoaded",ee);
